<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Notify コールバック</title>
</head>
<body>
    <h1>LINE Notify コールバック</h1>
    <p id="message">処理中...</p>

    <script>
        // クライアントシークレットを使ってトークン取得（セキュリティ上はサーバーで実行するべきですが、今回は全てクライアントで処理）
        const clientId = 'oH3GsOBlIDGZuDFTHLW0YB'; // LINE NotifyのクライアントID
        const clientSecret = 'MJDHVpGuRouw2rhfELMyuE25vqFIneyGcFWjZjhvIDX'; // LINE Notifyのクライアントシークレット
        const redirectUri = window.location.origin + '/callback.html'; // 自分のリダイレクトURL

        // URLパラメータから認証コードとステートを取得
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state').split(',');

        const grade = state[0];
        const email = state[1];
        const name = state[2];
        const eventDate = state[3];
        const attendance = state[4];

        if (code) {
            // トークンを取得するリクエスト
            const tokenUrl = 'https://notify-bot.line.me/oauth/token';
            const data = {
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                client_id: clientId,
                client_secret: clientSecret
            };

            fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.access_token) {
                    // アクセストークンが取得できたら、メッセージを送信
                    sendLineNotify(result.access_token, grade, email, name, eventDate, attendance);
                } else {
                    document.getElementById('message').textContent = 'アクセストークンの取得に失敗しました。';
                }
            })
            .catch(error => {
                document.getElementById('message').textContent = 'エラーが発生しました。';
            });
        } else {
            document.getElementById('message').textContent = '認証コードがありません。';
        }

        // LINE Notifyでメッセージを送信
        function sendLineNotify(token, grade, email, name, eventDate, attendance) {
            const notifyUrl = 'https://notify-api.line.me/api/notify';
            const message = `出席登録\n学年: ${grade}\n名前: ${name}\nメールアドレス: ${email}\n開催日: ${eventDate}\n出席状況: ${attendance}`;
            
            fetch(notifyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: new URLSearchParams({ message })
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('message').textContent = 'LINEに通知を送信しました。';
            })
            .catch(error => {
                document.getElementById('message').textContent = '通知の送信に失敗しました。';
            });
        }
    </script>
</body>
</html>
